<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificación de Afiliados</title>
  <style>
    /* RESET y base */
    html, body {
      margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif;
      background-color: #e6e6e6;
    }
    body {
      display: flex; justify-content: center; align-items: center;
    }
    button, input {
      font-family: Arial, sans-serif;
    }

    /* Verificación */
    #verificacion-contenedor {
      background: white;
      width: 800px;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      padding: 30px 40px 40px 40px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }

    h1 {
      color: #003366;
      font-size: 32px;
      text-align: center;
      margin-bottom: 10px;
    }

    form {
      flex-grow: 1;
    }

    label {
      font-size: 20px;
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      margin-top: 20px;
      padding: 14px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      width: 100%;
    }

    button:hover {
      background-color: #0055aa;
    }

    #resultado {
      margin-top: 15px;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
    }

    #resultado.afiliado {
      color: green;
    }

    #resultado.no-afiliado {
      color: red;
    }

    .logo-bottom {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 15px;
    }

    .logo-bottom img {
      max-height: 340px;
      width: auto;
      object-fit: contain;
      display: block;
      margin-top: 15px;
    }

    /* Botón admin pequeño fijo */
    #btn-admin {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      padding: 8px 12px;
      cursor: pointer;
      z-index: 1000;
      width: auto;
      height: auto;
    }
    #btn-admin:hover {
      background-color: #0055aa;
    }

    /* Modal PIN */
    #modal-pin {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #modal-pin.active {
      display: flex;
    }
    #modal-pin .modal-content {
      background: white;
      padding: 30px 40px;
      border-radius: 10px;
      max-width: 320px;
      width: 90%;
      box-sizing: border-box;
      text-align: center;
      color: #003366;
    }
    #modal-pin input {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #modal-pin button {
      margin-top: 15px;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #003366;
      color: white;
      cursor: pointer;
      width: 100%;
    }
    #modal-pin button:hover {
      background-color: #0055aa;
    }
    #mensaje-pin {
      margin-top: 10px;
      font-weight: bold;
      color: red;
    }

    /* ADMIN PAGE */

    #admin-page {
      display: none;
      max-width: 1200px;
      margin: 30px auto;
      height: 80vh;
      display: flex;
      gap: 20px;
      font-family: Arial, sans-serif;
      color: #003366;
    }
    #admin-page.active {
      display: flex;
    }

    /* Izquierda: formularios */
    #admin-formularios {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: white;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
      min-width: 320px;
    }
    .formulario-admin {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
    }
    .formulario-admin h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
    }
    form.admin-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    form.admin-form label {
      font-weight: bold;
      font-size: 14px;
    }
    form.admin-form input {
      padding: 8px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    form.admin-form button {
      background-color: #003366;
      color: white;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    form.admin-form button:hover {
      background-color: #0055aa;
    }
    .mensaje-exito {
      color: green;
      font-weight: bold;
      font-size: 14px;
      margin-top: 5px;
    }
    .mensaje-error {
      color: red;
      font-weight: bold;
      font-size: 14px;
      margin-top: 5px;
    }

    /* Derecha: logs arriba, listado abajo */
    #admin-derecha {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #admin-logs, #admin-listado {
      background: white;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
    }
    #admin-logs {
      flex: 1.2;
    }
    #admin-listado {
      flex: 1;
    }

    #admin-logs h2, #admin-listado h2 {
      margin-top: 0;
    }

    #tabla-logs, #tabla-afiliados {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    #tabla-logs th, #tabla-logs td,
    #tabla-afiliados th, #tabla-afiliados td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }
    #tabla-logs th, #tabla-afiliados th {
      background-color: #003366;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Responsive móvil admin */
    @media (max-width: 768px) {
      body {
        height: auto;
      }
      #verificacion-contenedor {
        width: 95%;
        max-height: none;
        padding: 20px;
      }
      h1 {
        font-size: 28px;
      }
      label, input, button, #resultado {
        font-size: 16px;
      }
      .logo-bottom img {
        max-height: 220px;
        margin-top: 10px;
      }

      #admin-page {
        flex-direction: column;
        height: auto;
        margin: 10px;
      }
      #admin-formularios {
        max-height: none;
        order: 1;
        height: auto;
      }
      #admin-logs {
        order: 2;
        max-height: 300px;
      }
      #admin-listado {
        order: 3;
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Botón ADMIN fijo -->
  <button id="btn-admin">ADMIN</button>

  <!-- Contenedor verificación -->
  <div id="verificacion-contenedor">
    <h1>Verificación de Afiliados</h1>
    <form id="formulario">
      <label for="dni">DNI</label>
      <input type="text" id="dni" name="dni" required />
      <button type="submit">Verificar</button>
    </form>

    <div id="resultado"></div>
    <button id="descargar" style="display:none;">Ver Credencial</button>

    <div class="logo-bottom">
      <img src="https://i.imgur.com/ZXJvT6b.png" alt="Logo de la empresa" />
    </div>
  </div>

  <!-- Modal PIN -->
  <div id="modal-pin">
    <div class="modal-content">
      <h3>Ingrese PIN de administrador</h3>
      <input type="password" id="input-pin" maxlength="10" />
      <button id="btn-pin-aceptar">Aceptar</button>
      <button id="btn-pin-cancelar" style="margin-top:8px; background:#ccc; color:#000;">Cancelar</button>
      <div id="mensaje-pin"></div>
    </div>
  </div>

  <!-- Página Admin (se carga en nueva pestaña) -->
  <div id="admin-page" style="display:none;">
    <div id="admin-formularios">
      <!-- Formularios agregados por JS -->
    </div>

    <div id="admin-derecha">
      <div id="admin-logs">
        <h2>Registro de Cambios</h2>
        <table id="tabla-logs">
          <thead>
            <tr>
              <th>Acción</th>
              <th>DNI</th>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>N° Afiliado</th>
              <th>Fecha Modificación</th>
            </tr>
          </thead>
          <tbody id="logs-body"></tbody>
        </table>
      </div>

      <div id="admin-listado">
        <h2>Listado de Afiliados</h2>
        <table id="tabla-afiliados">
          <thead>
            <tr>
              <th>N° Afiliado</th>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>DNI</th>
            </tr>
          </thead>
          <tbody id="afiliados-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const baseURL = 'http://localhost:8080'; // Cambia según tu backend
  let dniAfiliado = '';

  // --- Verificación ---
  const form = document.getElementById('formulario');
  const resultadoDiv = document.getElementById('resultado');
  const descargarBtn = document.getElementById('descargar');

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const dni = document.getElementById('dni').value.trim();
    dniAfiliado = dni;

    resultadoDiv.textContent = '';
    resultadoDiv.className = '';

    try {
      const response = await fetch(`${baseURL}/verificar`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({dni})
      });

      if (!response.ok) throw new Error('Error en la consulta');

      const data = await response.json();

      if(data.afiliado) {
        const nombreCompleto = data.datos.nombre_completo;
        const partes = nombreCompleto.split(',');
        const apellido = partes[0]?.trim() || '';
        const nombre = partes[1]?.trim() || '';
        resultadoDiv.textContent = `✅ AFILIADO: ${nombre} ${apellido} (N° ${data.datos.nro_afiliado})`;
        resultadoDiv.className = 'afiliado';
        descargarBtn.style.display = 'block';
      } else {
        resultadoDiv.textContent = '❌ No se encontró afiliado con ese DNI.';
        resultadoDiv.className = 'no-afiliado';
        descargarBtn.style.display = 'none';
      }
    } catch(err) {
      resultadoDiv.textContent = '⚠️ Error al conectar con el servidor.';
      resultadoDiv.className = 'error';
      console.error(err);
    }
  });

  descargarBtn.addEventListener('click', () => {
    if (!dniAfiliado) return;
    const url = `${baseURL}/credencial`;
    const formCred = document.createElement('form');
    formCred.method = 'POST';
    formCred.action = url;
    formCred.target = '_blank';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'dni';
    input.value = dniAfiliado;
    formCred.appendChild(input);

    document.body.appendChild(formCred);
    formCred.submit();
    document.body.removeChild(formCred);
  });

  // --- ADMIN ---

  const btnAdmin = document.getElementById('btn-admin');
  const modalPin = document.getElementById('modal-pin');
  const inputPin = document.getElementById('input-pin');
  const btnPinAceptar = document.getElementById('btn-pin-aceptar');
  const btnPinCancelar = document.getElementById('btn-pin-cancelar');
  const mensajePin = document.getElementById('mensaje-pin');

  btnAdmin.addEventListener('click', () => {
    modalPin.classList.add('active');
    inputPin.value = '';
    mensajePin.textContent = '';
    inputPin.focus();
  });
  btnPinCancelar.addEventListener('click', () => {
    modalPin.classList.remove('active');
  });

  btnPinAceptar.addEventListener('click', async () => {
    const pin = inputPin.value.trim();
    if (!pin) {
      mensajePin.textContent = 'Ingrese un PIN válido';
      return;
    }
    try {
      const res = await fetch(`${baseURL}/admin/listar-afiliados?pin=${encodeURIComponent(pin)}`);
      if (!res.ok) throw new Error('PIN incorrecto');
      // PIN correcto: abrir nueva pestaña admin con PIN en query param
      const adminURL = window.location.origin + window.location.pathname + `?admin=1&pin=${encodeURIComponent(pin)}`;
      window.open(adminURL, '_blank');
      modalPin.classList.remove('active');
    } catch {
      mensajePin.textContent = 'PIN incorrecto';
    }
  });

  // --- Página admin: detectar si estoy en modo admin (query ?admin=1&pin=xxx) ---
  function getQueryParams() {
    const params = {};
    location.search.substring(1).split("&").forEach(part => {
      if (!part) return;
      const [key,val] = part.split("=");
      params[decodeURIComponent(key)] = decodeURIComponent(val);
    });
    return params;
  }

  const params = getQueryParams();
  if(params.admin === '1' && params.pin) {
    document.body.innerHTML = ''; // limpio todo para solo mostrar admin
    mostrarAdminPage(params.pin);
  }

  async function mostrarAdminPage(pin) {
    document.title = 'Panel de Administración - Afiliados';

    // Contenedor principal
    const container = document.createElement('div');
    container.id = 'admin-page';
    container.classList.add('active');

    // Izquierda: formularios
    const left = document.createElement('div');
    left.id = 'admin-formularios';

    // Formulario Agregar
    left.innerHTML += `
      <div class="formulario-admin">
        <h2>Agregar Afiliado</h2>
        <form id="form-agregar" class="admin-form">
          <label for="add-nro-afiliado">N° Afiliado</label>
          <input type="text" id="add-nro-afiliado" required />
          <label for="add-nombre-completo">Nombre Completo</label>
          <input type="text" id="add-nombre-completo" required />
          <label for="add-dni">DNI</label>
          <input type="text" id="add-dni" required />
          <button type="submit">Agregar</button>
          <div id="msg-agregar"></div>
        </form>
      </div>
    `;

    // Formulario Editar
    left.innerHTML += `
      <div class="formulario-admin">
        <h2>Editar Afiliado</h2>
        <form id="form-editar" class="admin-form">
          <label for="edit-nro-afiliado">N° Afiliado</label>
          <input type="text" id="edit-nro-afiliado" required />
          <label for="edit-nombre-completo">Nombre Completo</label>
          <input type="text" id="edit-nombre-completo" required />
          <label for="edit-dni">DNI (para buscar)</label>
          <input type="text" id="edit-dni" required />
          <button type="submit">Editar</button>
          <div id="msg-editar"></div>
        </form>
      </div>
    `;

    // Formulario Eliminar
    left.innerHTML += `
      <div class="formulario-admin">
        <h2>Eliminar Afiliado</h2>
        <form id="form-eliminar" class="admin-form">
          <label for="del-dni">DNI</label>
          <input type="text" id="del-dni" required />
          <button type="submit">Eliminar</button>
          <div id="msg-eliminar"></div>
        </form>
      </div>
    `;

    // Derecha: logs arriba, listado abajo
    const right = document.createElement('div');
    right.id = 'admin-derecha';
    right.innerHTML = `
      <div id="admin-logs">
        <h2>Registro de Cambios</h2>
        <table id="tabla-logs">
          <thead>
            <tr>
              <th>Acción</th>
              <th>DNI</th>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>N° Afiliado</th>
              <th>Fecha Modificación</th>
            </tr>
          </thead>
          <tbody id="logs-body"></tbody>
        </table>
      </div>

      <div id="admin-listado">
        <h2>Listado de Afiliados</h2>
        <table id="tabla-afiliados">
          <thead>
            <tr>
              <th>N° Afiliado</th>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>DNI</th>
            </tr>
          </thead>
          <tbody id="afiliados-body"></tbody>
        </table>
      </div>
    `;

    container.appendChild(left);
    container.appendChild(right);
    document.body.appendChild(container);

    // Funciones para cargar datos
    await cargarAfiliados(pin);
    await cargarLogs(pin);

    // Eventos formularios
    document.getElementById('form-agregar').addEventListener('submit', async e => {
      e.preventDefault();
      const nro_afiliado = document.getElementById('add-nro-afiliado').value.trim();
      const nombre_completo = document.getElementById('add-nombre-completo').value.trim();
      const dni = document.getElementById('add-dni').value.trim();
      const msg = document.getElementById('msg-agregar');
      msg.textContent = '';

      if(!nro_afiliado || !nombre_completo || !dni) {
        msg.textContent = 'Complete todos los campos';
        msg.className = 'mensaje-error';
        return;
      }

      try {
        const res = await fetch(`${baseURL}/admin/agregar-afiliado`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({nro_afiliado, nombre_completo, dni, pin})
        });
        if(!res.ok) throw new Error('Error al agregar');
        const data = await res.json();
        if(data.success) {
          msg.textContent = 'Afiliado agregado con éxito';
          msg.className = 'mensaje-exito';
          await cargarAfiliados(pin);
          await cargarLogs(pin);
          // limpiar campos
          document.getElementById('add-nro-afiliado').value = '';
          document.getElementById('add-nombre-completo').value = '';
          document.getElementById('add-dni').value = '';
        } else {
          msg.textContent = data.message || 'Error al agregar';
          msg.className = 'mensaje-error';
        }
      } catch(err) {
        msg.textContent = 'Error en la conexión';
        msg.className = 'mensaje-error';
      }
    });

    document.getElementById('form-editar').addEventListener('submit', async e => {
      e.preventDefault();
      const nro_afiliado = document.getElementById('edit-nro-afiliado').value.trim();
      const nombre_completo = document.getElementById('edit-nombre-completo').value.trim();
      const dni = document.getElementById('edit-dni').value.trim();
      const msg = document.getElementById('msg-editar');
      msg.textContent = '';

      if(!nro_afiliado || !nombre_completo || !dni) {
        msg.textContent = 'Complete todos los campos';
        msg.className = 'mensaje-error';
        return;
      }

      try {
        const res = await fetch(`${baseURL}/admin/editar-afiliado`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({nro_afiliado, nombre_completo, dni, pin})
        });
        if(!res.ok) throw new Error('Error al editar');
        const data = await res.json();
        if(data.success) {
          msg.textContent = 'Afiliado editado con éxito';
          msg.className = 'mensaje-exito';
          await cargarAfiliados(pin);
          await cargarLogs(pin);
          // limpiar campos
          document.getElementById('edit-nro-afiliado').value = '';
          document.getElementById('edit-nombre-completo').value = '';
          document.getElementById('edit-dni').value = '';
        } else {
          msg.textContent = data.message || 'Error al editar';
          msg.className = 'mensaje-error';
        }
      } catch(err) {
        msg.textContent = 'Error en la conexión';
        msg.className = 'mensaje-error';
      }
    });

    document.getElementById('form-eliminar').addEventListener('submit', async e => {
      e.preventDefault();
      const dni = document.getElementById('del-dni').value.trim();
      const msg = document.getElementById('msg-eliminar');
      msg.textContent = '';

      if(!dni) {
        msg.textContent = 'Ingrese DNI';
        msg.className = 'mensaje-error';
        return;
      }

      try {
        const res = await fetch(`${baseURL}/admin/eliminar-afiliado`, {
          method: 'DELETE',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({dni, pin})
        });
        if(!res.ok) throw new Error('Error al eliminar');
        const data = await res.json();
        if(data.success) {
          msg.textContent = 'Afiliado eliminado con éxito';
          msg.className = 'mensaje-exito';
          await cargarAfiliados(pin);
          await cargarLogs(pin);
          document.getElementById('del-dni').value = '';
        } else {
          msg.textContent = data.message || 'Error al eliminar';
          msg.className = 'mensaje-error';
        }
      } catch(err) {
        msg.textContent = 'Error en la conexión';
        msg.className = 'mensaje-error';
      }
    });
  }

  async function cargarAfiliados(pin) {
    try {
      const res = await fetch(`${baseURL}/admin/listar-afiliados?pin=${encodeURIComponent(pin)}`);
      if(!res.ok) throw new Error('Error al cargar afiliados');
      const data = await res.json();
      const tbody = document.getElementById('afiliados-body');
      tbody.innerHTML = '';
      data.forEach(a => {
        // Desglosar nombre y apellido de nombre_completo separado por coma
        let apellido = '';
        let nombre = '';
        if(a.nombre_completo) {
          const partes = a.nombre_completo.split(',');
          apellido = partes[0]?.trim() || '';
          nombre = partes[1]?.trim() || '';
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.nro_afiliado || ''}</td>
          <td>${apellido}</td>
          <td>${nombre}</td>
          <td>${a.dni || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch(e) {
      console.error('Error al cargar afiliados:', e);
    }
  }

  async function cargarLogs(pin) {
    try {
      const res = await fetch(`${baseURL}/admin/listar-logs?pin=${encodeURIComponent(pin)}`);
      if(!res.ok) throw new Error('Error al cargar logs');
      const data = await res.json();
      const tbody = document.getElementById('logs-body');
      tbody.innerHTML = '';
      data.forEach(log => {
        // Log esperado: { accion, dni, nombre_completo, nro_afiliado, fecha_modificacion }
        // Parsear nombre y apellido
        let apellido = '';
        let nombre = '';
        if(log.nombre_completo) {
          const partes = log.nombre_completo.split(',');
          apellido = partes[0]?.trim() || '';
          nombre = partes[1]?.trim() || '';
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${log.accion || ''}</td>
          <td>${log.dni || ''}</td>
          <td>${apellido}</td>
          <td>${nombre}</td>
          <td>${log.nro_afiliado || ''}</td>
          <td>${log.fecha_modificacion || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch(e) {
      console.error('Error al cargar logs:', e);
    }
  }
</script>
</body>
</html>



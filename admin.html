<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Administradores</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e6e6e6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #003366;
      margin: 20px 0 10px 0;
      font-size: 28px;
      text-align: center;
    }

    #pin-container {
      margin-bottom: 20px;
      text-align: center;
    }

    #admin-panel {
      display: none;
      width: 95%;
      max-width: 1200px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      padding: 20px;
      box-sizing: border-box;
    }

    .admin-layout {
      display: flex;
      gap: 20px;
    }

    .left-panel, .right-panel {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      box-sizing: border-box;
    }

    .left-panel {
      flex: 1.2;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .right-panel {
      flex: 1;
      max-height: 600px;
      overflow-y: auto;
    }

    form {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    form label {
      font-weight: bold;
      color: #003366;
      font-size: 14px;
    }

    form input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    form button {
      margin-top: 10px;
      padding: 10px;
      font-size: 15px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    form button:hover {
      background-color: #0055aa;
    }

    .message {
      font-weight: bold;
      font-size: 14px;
      margin-top: 6px;
      min-height: 18px;
    }

    .message.success {
      color: green;
    }

    .message.error {
      color: red;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }

    table th {
      background: #003366;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* Responsive celular: 
       primero formularios arriba,
       luego logs,
       luego listado afiliados */
    @media (max-width: 700px) {
      .admin-layout {
        flex-direction: column;
      }
      .left-panel, .right-panel {
        max-height: none;
        overflow: visible;
      }
      #forms-container {
        order: 1;
      }
      #logs-panel {
        order: 2;
        margin-top: 20px;
      }
      #listado-panel {
        order: 3;
        margin-top: 20px;
      }
    }
  </style>
</head>
<body>

  <h1>PANEL DE ADMINISTRADORES</h1>

  <div id="pin-container">
    <input type="password" id="pin-input" placeholder="Ingrese PIN" />
    <button id="pin-submit">Entrar</button>
    <div id="pin-message" style="color:red; margin-top:5px;"></div>
  </div>

  <div id="admin-panel">
    <div class="admin-layout">

      <div class="left-panel" id="forms-container">
        <!-- FORMULARIOS -->
        <form id="form-cargar">
          <h3>Cargar Afiliado</h3>
          <label for="nro_afiliado_cargar">N° Afiliado</label>
          <input type="text" id="nro_afiliado_cargar" required />
          <label for="nombre_completo_cargar">Nombre Completo</label>
          <input type="text" id="nombre_completo_cargar" required />
          <label for="dni_cargar">DNI</label>
          <input type="text" id="dni_cargar" required />
          <button type="submit">Agregar</button>
          <div class="message" id="msg-cargar"></div>
        </form>

        <form id="form-editar">
          <h3>Editar Afiliado</h3>
          <label for="dni_editar">DNI (buscar)</label>
          <input type="text" id="dni_editar" required />
          <label for="nro_afiliado_editar">Nuevo N° Afiliado</label>
          <input type="text" id="nro_afiliado_editar" required />
          <label for="nombre_completo_editar">Nuevo Nombre Completo</label>
          <input type="text" id="nombre_completo_editar" required />
          <button type="submit">Modificar</button>
          <div class="message" id="msg-editar"></div>
        </form>

        <form id="form-eliminar">
          <h3>Eliminar Afiliado</h3>
          <label for="dni_eliminar">DNI</label>
          <input type="text" id="dni_eliminar" required />
          <button type="submit">Eliminar</button>
          <div class="message" id="msg-eliminar"></div>
        </form>
      </div>

      <div class="right-panel" id="logs-panel">
        <h3>Registro de Cambios (Últimos 100)</h3>
        <table id="logs-table">
          <thead>
            <tr>
              <th>Acción</th>
              <th>DNI</th>
              <th>Nombre Completo</th>
              <th>N° Afiliado</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="listado-panel" style="margin-top: 25px;">
      <h3>Listado de Afiliados</h3>
      <table id="afiliados-table">
        <thead>
          <tr>
            <th>N° Afiliado</th>
            <th>Nombre Completo</th>
            <th>DNI</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const ADMIN_PIN = '1234';
    const headers = { 'Content-Type': 'application/json', 'x-admin-pin': ADMIN_PIN };

    const pinContainer = document.getElementById('pin-container');
    const pinInput = document.getElementById('pin-input');
    const pinSubmit = document.getElementById('pin-submit');
    const pinMessage = document.getElementById('pin-message');

    const adminPanel = document.getElementById('admin-panel');

    // Formularios
    const formCargar = document.getElementById('form-cargar');
    const formEditar = document.getElementById('form-editar');
    const formEliminar = document.getElementById('form-eliminar');

    // Mensajes
    const msgCargar = document.getElementById('msg-cargar');
    const msgEditar = document.getElementById('msg-editar');
    const msgEliminar = document.getElementById('msg-eliminar');

    // Tablas
    const logsTableBody = document.querySelector('#logs-table tbody');
    const afiliadosTableBody = document.querySelector('#afiliados-table tbody');

    // Base URL backend
    const BASE_URL = 'http://localhost:8080';

    // Mostrar panel admin si PIN es correcto
    pinSubmit.addEventListener('click', () => {
      const pin = pinInput.value.trim();
      if (pin !== ADMIN_PIN) {
        pinMessage.textContent = 'PIN incorrecto';
        return;
      }
      pinMessage.textContent = '';
      pinContainer.style.display = 'none';
      adminPanel.style.display = 'block';

      cargarLogs();
      cargarAfiliados();
    });

    // Función para cargar logs
    async function cargarLogs() {
      try {
        const res = await fetch(`${BASE_URL}/admin/listar-logs`, {
          headers
        });
        if (!res.ok) throw new Error('Error al cargar logs');
        const logs = await res.json();

        logsTableBody.innerHTML = '';
        logs.forEach(log => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${log.accion}</td>
            <td>${log.dni}</td>
            <td>${log.nombre_completo}</td>
            <td>${log.nro_afiliado}</td>
            <td>${new Date(log.fecha).toLocaleString('es-AR')}</td>
          `;
          logsTableBody.appendChild(tr);
        });
      } catch (error) {
        logsTableBody.innerHTML = `<tr><td colspan="5" style="color:red;">Error al cargar logs</td></tr>`;
        console.error(error);
      }
    }

    // Función para cargar afiliados
    async function cargarAfiliados() {
      try {
        const res = await fetch(`${BASE_URL}/admin/listar-afiliados`, {
          headers
        });
        if (!res.ok) throw new Error('Error al cargar afiliados');
        const afiliados = await res.json();

        afiliadosTableBody.innerHTML = '';
        afiliados.forEach(afiliado => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${afiliado.nro_afiliado}</td>
            <td>${afiliado.nombre_completo}</td>
            <td>${afiliado.dni}</td>
          `;
          afiliadosTableBody.appendChild(tr);
        });
      } catch (error) {
        afiliadosTableBody.innerHTML = `<tr><td colspan="3" style="color:red;">Error al cargar afiliados</td></tr>`;
        console.error(error);
      }
    }

    // Manejo formularios

    // Agregar afiliado
    formCargar.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgCargar.textContent = '';
      const nro_afiliado = document.getElementById('nro_afiliado_cargar').value.trim();
      const nombre_completo = document.getElementById('nombre_completo_cargar').value.trim();
      const dni = document.getElementById('dni_cargar').value.trim();

      try {
        const res = await fetch(`${BASE_URL}/admin/cargar-afiliados`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ nro_afiliado, nombre_completo, dni })
        });
        const data = await res.json();
        if (res.ok) {
          msgCargar.textContent = data.message || 'Afiliado agregado';
          msgCargar.className = 'message success';
          formCargar.reset();
          cargarAfiliados();
          cargarLogs();
        } else {
          msgCargar.textContent = data.error || 'Error al agregar afiliado';
          msgCargar.className = 'message error';
        }
      } catch (error) {
        msgCargar.textContent = 'Error de conexión';
        msgCargar.className = 'message error';
      }
    });

    // Editar afiliado
    formEditar.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgEditar.textContent = '';
      const dni = document.getElementById('dni_editar').value.trim();
      const nro_afiliado = document.getElementById('nro_afiliado_editar').value.trim();
      const nombre_completo = document.getElementById('nombre_completo_editar').value.trim();

      try {
        const res = await fetch(`${BASE_URL}/admin/editar-afiliado`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({ dni, nro_afiliado, nombre_completo })
        });
        const data = await res.json();
        if (res.ok) {
          msgEditar.textContent = data.message || 'Afiliado modificado';
          msgEditar.className = 'message success';
          formEditar.reset();
          cargarAfiliados();
          cargarLogs();
        } else {
          msgEditar.textContent = data.error || 'Error al modificar afiliado';
          msgEditar.className = 'message error';
        }
      } catch (error) {
        msgEditar.textContent = 'Error de conexión';
        msgEditar.className = 'message error';
      }
    });

    // Eliminar afiliado
    formEliminar.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgEliminar.textContent = '';
      const dni = document.getElementById('dni_eliminar').value.trim();

      try {
        const res = await fetch(`${BASE_URL}/admin/eliminar-afiliado`, {
          method: 'DELETE',
          headers,
          body: JSON.stringify({ dni })
        });
        const data = await res.json();
        if (res.ok) {
          msgEliminar.textContent = data.message || 'Afiliado eliminado';
          msgEliminar.className = 'message success';
          formEliminar.reset();
          cargarAfiliados();
          cargarLogs();
        } else {
          msgEliminar.textContent = data.error || 'Error al eliminar afiliado';
          msgEliminar.className = 'message error';
        }
      } catch (error) {
        msgEliminar.textContent = 'Error de conexión';
        msgEliminar.className = 'message error';
      }
    });
  </script>
</body>
</html>



